{% extends "base.html" %}
{% load static %}
{% load setting_tags %}

{% block title %}ì„¤ì •{% endblock %}

{% block style %}
<style>
    .top-buttons { margin-bottom: 20px; }
    .top-buttons button {
        padding: 6px 15px;
        margin-right: 10px;
        border: none;
        border-radius: 4px;
        color: white;
        font-weight: bold;
    }
    .save-btn { background-color: #888; }
    .cancel-btn { background-color: #e74c3c; }
    .submit-btn { background-color: #2ecc71; }
    .detail-button { margin-left: 10px; padding: 2px 8px; font-size: 12px; }
    .block {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .row {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<h2 style="margin-top: 0;">ğŸŒ¿ Telofarm Control System ì„¤ì •</h2>
<form method="post" onsubmit="return false;">
    {% csrf_token %}
    <div class="top-buttons">
        <a href="/settings/download/">
            <button type="button" class="save-btn">ì €ì¥ ê°’ ì¶”ì¶œ</button>
        </a>
        <label class="upload-btn" style="cursor: pointer; background: #3498db; padding: 6px 12px; color: white; border-radius: 4px;">
            ğŸ“¤ ì €ì¥ ê°’ ë®ì–´ì“°ê¸°
            <input type="file" accept=".json" onchange="uploadSettingJson(this)" style="display:none">
        </label>
    </div>

    <div class="row">
        <div class="block" style="flex: 1;">
            <h3>TelofarmControl ì„¤ì •</h3>

            <label>ë¦´ë ˆì´ë³´ë“œ íƒ€ì…</label>
            <select name="relayboard_type" onchange="autoSave(this)">
                <option value="4port" {% if setting.relayboard_type == '4port' %}selected{% endif %}>4PORT</option>
                <option value="8port" {% if setting.relayboard_type == '8port' %}selected{% endif %}>8PORT</option>
            </select><br>

            <label>ê¸°ìƒì„¼ì„œ í¬íŠ¸</label>
            <select name="sensor_ports" onchange="autoSave(this)">
                {% for i in "123456789" %}
                <option value="com{{ i }}" {% if setting.sensor_ports == "com"|add:i %}selected{% endif %}>com{{ i }}</option>
                {% endfor %}
            </select><br>

            <label>í…ŒìŠ¤íŠ¸ ëª¨ë“œ1</label>
            <input type="checkbox" name="test_mode" {% if setting.test_mode %}checked{% endif %}">
        </div>

        {{ setting|json_script:"setting-data" }}

        <div class="block" style="flex: 1;">
            <h3>ê´€ìˆ˜ ì±„ë„ ì„¤ì •</h3>
            {% for i in "1234" %}
            <label>Ch{{ i }} ì‚¬ìš©</label>
            <input type="checkbox" name="irrigation_channels_{{ i }}" {% if setting.irrigation_channels|get_item:i %}checked{% endif %} onchange="autoSave(this)">
            <button type="button" class="detail-button" onclick="openIrrigationDetail({{ i }})">ìƒì„¸ì„¤ì • ì—´ê¸°</button><br>
            {% endfor %}
        </div>

        <div class="block" style="flex: 1;">
            <h3>LED ì±„ë„ ì„¤ì •</h3>
            {% for i in "1234" %}
            <label>LED Ch{{ i }} ì‚¬ìš©</label>
            <input type="checkbox" name="led_channels_{{ i }}" {% if setting.led_channels|get_item:i %}checked{% endif %} onchange="autoSave(this)">
            <button type="button" class="detail-button" onclick="openLedDetail({{ i }})">ìƒì„¸ì„¤ì • ì—´ê¸°</button><br>
            {% endfor %}
        </div>
    </div>

    <div id="detail-area"></div>
</form>


<script>

    function autoSave(element) {
        const name = element.name;
        const value = element.type === 'checkbox' ? element.checked : element.value;
        const payload = {};

        if (name.startsWith("irrigation_channels_")) {
            const ch = name.split("_")[2];
            payload.irrigation_channels = { [ch]: value };
        } else if (name.startsWith("led_channels_")) {
            const ch = name.split("_")[2];
            payload.led_channels = { [ch]: value };
        } else {
            payload[name] = value;
        }
    
        fetch("/settings/update/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        });
    }
    
    function openIrrigationDetail(ch) {
        const area = document.getElementById("detail-area");
        const setting = JSON.parse(document.getElementById('setting-data').textContent);
    
        const irrigationTime = setting.irrigationpanel.irrigation_time[ch] || 100;
        const relayPort = setting.irrigationpanel.relay_port_mapping[ch] || 0;
        const mode = setting.irrigationpanel.control_mode[ch] || "timer";
        const timeList = setting.time_control[ch] || ["10:00", "12:00", "14:00", "16:00"];
        const sensor = setting.sensor_settings[ch] || {};
    
        area.innerHTML = `
            <div class="header-with-button" style="display: flex; justify-content: space-between; align-items: center;">
                <h3>ê´€ìˆ˜ ${ch}ì±„ë„ ì„¤ì •</h3>
                <button type="button" class="done-btn" onclick="document.getElementById('detail-area').innerHTML=''">âœ… ë‹«ê¸°</button>
            </div>
            <div class="row">
                <div class="block" style="flex:1; position: relative; padding-bottom: 60px;">
                    <h4>ê¸°ë³¸ ì„¤ì •</h4>
                    <h4>ì œì–´ ë°©ì‹ ì„ íƒ</h4>
                    <div style="margin-bottom: 15px;">
                        <label>
                            <input type="radio" name="control_mode_${ch}" value="timer" ${mode === 'timer' ? 'checked' : ''}> ì‹œê°„ì œì–´
                        </label>
                        <label style="margin-left: 20px;">
                            <input type="radio" name="control_mode_${ch}" value="sensor" ${mode === 'sensor' ? 'checked' : ''}> ì„¼ì„œì œì–´
                        </label>
                    </div>
                    <label>ê´€ìˆ˜ì‹œê°„ (ì´ˆ)</label>
                    <input type="number" name="irrigation_time_${ch}" value="${irrigationTime}"><br>
    
                    <label>ë¦´ë ˆì´ í¬íŠ¸</label>
                    <select name="relay_port_${ch}">
                        ${[0,1,2,3,4,5,6,7].map(n => `<option value="${n}" ${relayPort==n?'selected':''}>${n}</option>`).join('')}
                    </select>
    
                    <div style="position: absolute; bottom: 15px; right: 15px; display: flex; gap: 10px;">
                        <button type="button" class="apply-btn"  onclick="saveIrrigationBasic(${ch})">ğŸ’¾ ì ìš©</button>
                    </div>
                </div>
    
                <div class="block" style="flex:1; position: relative; padding-bottom: 60px;">
                    <h4>ì‹œê°„ì œì–´ ì„¤ì •</h4>
                    <div id="time-schedule-area">
                        ${timeList.map((time, i) => `
                            <div class="time-entry">
                                <input type="time" name="time_schedule_${ch}_${i+1}" value="${time}">
                            </div>`).join('')}
                    </div>
                    <button type="button" class="add-btn" onclick="addTimeSchedule(${ch})">â•</button>
                    <button type="button" class="remove-btn" onclick="removeLastSchedule()">ğŸ—‘ï¸</button>
    
                    <div style="position: absolute; bottom: 15px; right: 15px; display: flex; gap: 10px;">
                        <button type="button" class="apply-btn"  onclick="saveIrrigationTime(${ch})">ğŸ’¾ ì ìš©</button>
                    </div>
                </div>
    
                <div class="block" style="flex:1; position: relative; padding-bottom: 80px;">
                    <h4>ì„¼ì„œì œì–´ ì„¤ì •</h4>
                    <label>ëª©í‘œ ìˆ˜ë¶„ê°’</label>
                    <input type="number" name="target_moisture_${ch}" value="${sensor.target || 175}"><br>
    
                    <label>ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘</label>
                    <input type="time" name="start_time_${ch}" value="${sensor.start_time || '09:00'}"> ~
                    <input type="time" name="end_time_${ch}" value="${sensor.end_time || '17:30'}"><br>
    
                    <label>ìƒˆë¡œê³ ì¹¨ ì£¼ê¸° (ì´ˆ)</label>
                    <input type="number" name="refresh_sec_${ch}" value="${sensor.refresh_sec || 300}"><br>
    
                    <label>Nf Value</label>
                    <input type="number" name="nf_value_${ch}" value="${sensor.nf_value || 68}"><br>
    
                    <label>dtm</label>
                    <input type="text" name="dtm_${ch}" value="${sensor.dtm || 1.15}"><br>
    
                    <label>ë°ì´í„° í…Œì´ë¸” ì´ë¦„</label>
                    <input type="text" name="data_table_${ch}" value="${sensor.data_table || ''}"><br>
    
                    <label>ëª¨ë“ˆ ë¦¬ìŠ¤íŠ¸</label><br>
                    <textarea name="modules_${ch}" rows="4" cols="40">${sensor.modules || ''}</textarea><br>
    
                    <div style="position: absolute; bottom: 15px; right: 15px; display: flex; gap: 10px;">
                        <button type="button" class="apply-btn"  onclick="saveIrrigationSensor(${ch})">ğŸ’¾ ì ìš©</button>
                    </div>
                </div>
            </div>
        `;
    }

    function openLedDetail(ch) {
        const setting = JSON.parse(document.getElementById('setting-data').textContent);
        const area = document.getElementById("detail-area");

        const ledTime = setting.ledpanel.led_time[ch] || { on: "08:00", off: "17:00" };
        const relayPort = setting.ledpanel.led_port_mapping[ch] || 4;

        area.innerHTML = `
            <div class="row">
                <div class="block" style="flex: 1; position: relative; padding-bottom: 80px;">
                    <h4>LED ${ch}ì±„ë„ ìƒì„¸ ì„¤ì •</h4>
                    
                    <label>ON ì‹œê°„</label>
                    <input type="time" name="led_on_${ch}" value="${ledTime.on}"><br>

                    <label>OFF ì‹œê°„</label>
                    <input type="time" name="led_off_${ch}" value="${ledTime.off}"><br>

                    <label>ë¦´ë ˆì´ í¬íŠ¸</label>
                    <select name="led_relay_port_${ch}">
                        ${[0, 1, 2, 3, 4, 5, 6, 7].map(n => `<option value="${n}" ${relayPort==n?'selected':''}>${n}</option>`).join('')}
                    </select><br>

                    <div style="position: absolute; right: 20px; bottom: 20px; display: flex; gap: 12px;">
                        <button type="button" class="apply-btn" onclick="saveLedDetail(${ch})">ğŸ’¾ ì ìš©</button>
                        <button type="button" class="done-btn" onclick="document.getElementById('detail-area').innerHTML=''">âœ… ë‹«ê¸°</button>
                    </div>
                </div>
            </div>
        `;
    }

    

    function removeLastSchedule() {
        const container = document.getElementById("time-schedule-area");
        const entries = container.querySelectorAll(".time-entry");
        if (entries.length > 1) {
            container.removeChild(entries[entries.length - 1]);
        }
    }
    function addTimeSchedule(ch) {
        const container = document.getElementById("time-schedule-area");
        const count = container.children.length + 1;
        const div = document.createElement("div");
        div.className = "time-entry";
        div.innerHTML = `
            <input type="time" name="time_schedule_${ch}_${count}" value="10:00">
        `;
        container.appendChild(div);
    }

    function autoSave(element) {
        const name = element.name;
        const value = element.type === 'checkbox' ? element.checked : element.value;

        fetch('/settings/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ [name]: value })
        });
    }

    function saveIrrigationBasic(ch) {
        const data = {
            irrigationpanel: {
                irrigation_time: { [ch]: parseInt(document.querySelector(`[name="irrigation_time_${ch}"]`).value) },
                relay_port_mapping: { [ch]: parseInt(document.querySelector(`[name="relay_port_${ch}"]`).value) },
                control_mode: { [ch]: document.querySelector(`[name="control_mode_${ch}"]:checked`).value }
            }
        };
    
        sendUpdate(data, `ê´€ìˆ˜ ${ch}ì±„ë„ ê¸°ë³¸ ì„¤ì •`);
    }

    function saveIrrigationTime(ch) {
        const timeList = Array.from(document.querySelectorAll(`[name^="time_schedule_${ch}_"]`)).map(el => el.value);
        const data = {
            time_control: {
                [ch]: timeList
            }
        };
    
        sendUpdate(data, `ê´€ìˆ˜ ${ch}ì±„ë„ ì‹œê°„ì œì–´ ì„¤ì •`);
    }

    function saveIrrigationSensor(ch) {
        const data = {
            sensor_settings: {
                [ch]: {
                    target: parseInt(document.querySelector(`[name="target_moisture_${ch}"]`).value),
                    start_time: document.querySelector(`[name="start_time_${ch}"]`).value,
                    end_time: document.querySelector(`[name="end_time_${ch}"]`).value,
                    refresh_sec: parseInt(document.querySelector(`[name="refresh_sec_${ch}"]`).value),
                    nf_value: parseInt(document.querySelector(`[name="nf_value_${ch}"]`).value),
                    dtm: parseFloat(document.querySelector(`[name="dtm_${ch}"]`).value),
                    data_table: document.querySelector(`[name="data_table_${ch}"]`).value,
                    modules: document.querySelector(`[name="modules_${ch}"]`).value
                }
            }
        };
    
        sendUpdate(data, `ê´€ìˆ˜ ${ch}ì±„ë„ ì„¼ì„œ ì„¤ì •`);
    }

    function saveLedDetail(ch) {
       
    
        const data = {
            ledpanel: {
                led_time: {
                    [ch]: {
                        on: document.querySelector(`[name="led_on_${ch}"]`).value,
                        off: document.querySelector(`[name="led_off_${ch}"]`).value
                    }
                },
                led_port_mapping: {
                    [ch]: parseInt(document.querySelector(`[name="led_relay_port_${ch}"]`).value)
                }
            }
        };
        
        sendUpdate(data,`LED ${ch}ì±„ë„ ì„¤ì • ì €ì¥ ì™„ë£Œ`);
    }
    
    function sendUpdate(data, label="ì„¤ì •") {
        fetch('/settings/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        }).then(() => {
            alert(`ğŸ’¾ ${label} ì €ì¥ ì™„ë£Œ`);
            // setting-data ì—…ë°ì´íŠ¸
            fetch('/settings/')
                .then(response => response.text())
                .then(html => {
                    // ì„ì‹œë¡œ DOM ê°ì²´ë¡œ íŒŒì‹±
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newScript = doc.getElementById('setting-data');
                    const currentScript = document.getElementById('setting-data');
                    if (newScript && currentScript) {
                        currentScript.textContent = newScript.textContent;
                    }
                });
        });
    }

    document.querySelector('form').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        // ëª¨ë“  input, select, textarea ìš”ì†Œì— ë³€ê²½ ì‹œ autoSave ì‹¤í–‰ ì—°ê²°
        document.querySelectorAll('input, select, textarea').forEach(el => {
            el.addEventListener('change', () => autoSave(el));
        });
    });

    
    function uploadSettingJson(input) {
        const file = input.files[0];
        if (!file) return;
    
        const formData = new FormData();
        formData.append('file', file);
    
        fetch('/settings/overwrite/', {
            method: 'POST',
            body: formData
        })
        .then(res => {
            if (!res.ok) throw new Error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
            return res.json();
        })
        .then(() => {
            alert("âœ… ì„¤ì • ë®ì–´ì“°ê¸° ì™„ë£Œ");
            location.reload();
        })
        .catch(err => alert(`âŒ ì˜¤ë¥˜: ${err.message}`));
    }

    {% comment %} document.getElementById("save-btn").addEventListener("click", saveSettings); {% endcomment %}
    {% comment %} document.getElementById("load-btn").addEventListener("click", loadSettings); {% endcomment %}
    </script>


{% endblock %}