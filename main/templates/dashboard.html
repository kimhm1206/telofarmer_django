{% extends "base.html" %}
{% block title %}ëŒ€ì‹œë³´ë“œ{% endblock %}
{% block content %}

<style>
  .desert-overview {
    background: linear-gradient(135deg, #ffe0b2, #ffe9c8);
    border-radius: 16px;
    padding: 20px;
    margin-top: 10px;
    margin-bottom: 22px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
    color: #5d4037;
  }
  .desert-overview__header {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 14px;
    align-items: flex-end;
    margin-bottom: 18px;
  }
  .desert-overview__title {
    font-size: 20px;
    font-weight: 700;
    margin: 0;
  }
  .desert-overview__time {
    margin: 4px 0 0 0;
    font-size: 12px;
    color: #6d4c41;
  }
  .desert-overview__cards {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  .desert-card {
    flex: 1 1 150px;
    min-width: 150px;
    background: rgba(255, 255, 255, 0.85);
    border-radius: 14px;
    padding: 15px;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4);
  }
  .desert-card__label {
    font-size: 12px;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    color: #8d6e63;
  }
  .desert-card__value {
    font-size: 24px;
    font-weight: 700;
    margin: 0;
  }
</style>

<div class="desert-overview">
  <div class="desert-overview__header">
    <div>
      <p class="desert-overview__title">ì‚¬ë§‰ í™˜ê²½ ì‹¤í—˜ í˜„í™©</p>
      <p class="desert-overview__time">í˜„ì¬ ì‹œê° <strong id="desert-clock">--:--</strong></p>
    </div>
  </div>
  <div class="desert-overview__cards">
    <div class="desert-card">
      <div class="desert-card__label">ì˜¨ë„</div>
      <p class="desert-card__value" id="desert-temp">50.0â„ƒ</p>
    </div>
    <div class="desert-card">
      <div class="desert-card__label">ìŠµë„</div>
      <p class="desert-card__value" id="desert-humidity">30.0%</p>
    </div>
    <div class="desert-card">
      <div class="desert-card__label">ê´‘ëŸ‰</div>
      <p class="desert-card__value" id="desert-irradiance">1kW/mÂ²</p>
    </div>
  </div>
</div>

<div style="margin-top: 40px; margin-bottom: 20px;display: flex; align-items: center;">
  <h2 style="margin: 0;">ğŸ’§ ê´€ìˆ˜ í˜„í™©</h2>
  <button onclick="alert('ì „ì²´ ìˆ˜ë™ ê´€ìˆ˜ ì‹œì‘'); sendManualToDjango('all')"style="
    margin-left: 30px;
    background-color: #4fc3f7;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  ">
    ì „ì²´ ìˆ˜ë™ ê´€ìˆ˜
  </button>
  <button onclick="alert('ê´€ìˆ˜ ë¹„ìƒ ì •ì§€ ì‹œì‘'); sendEmergency()"style="
    margin-left: 30px;
    background-color: #ff0000;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  ">
    ê´€ìˆ˜ ë¹„ìƒ ì •ì§€
  </button>
</div>
<div style="display: flex; flex-wrap: wrap; gap: 20px;">
  {% for irr in irrigation_info %}
    <div style="
      background-color: rgba(224,247,250, 1);
      padding: 16px 20px;
      border-radius: 12px;
      width: 240px;
      height: 260px;
      min-height: 260px;
      max-height: 260px;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    ">
    <!-- ì˜¤ë¥¸ìª½ ìƒë‹¨: ìƒíƒœ ë¨í”„ -->
    <div style="position: absolute; top: 12px; right: 12px;">
      <span id="irrigation-lamp-{{ irr.channel }}" class="status-dot" style="
        background-color: #ccc;
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        box-shadow: 0 0 4px #ccc;
      "></span>
    </div>

    <h4 style="margin: 0 0 10px 0;">
      ê´€ìˆ˜ ch{{ irr.channel }}
    </h4>

    <p style="margin: 4px 0;">ê´€ìˆ˜ ëª¨ë“œ : {% if irr.mode == "sensor" %}ì„¼ì„œ{% else %}ì‹œê°„{% endif %}</p>
    <p style="margin: 4px 0;">ì˜¤ëŠ˜ì˜ ê´€ìˆ˜ íšŸìˆ˜ : {{ irr.count }}</p>
    <p style="margin: 4px 0;">ìµœê·¼ ê´€ìˆ˜ ì‹œê°„ : {{ irr.last_time }}</p>
    {% if irr.mode == "timer" %}
      <p style="margin: 4px 0;">ë‹¤ìŒ ê´€ìˆ˜ ì‹œê°„ : {{ irr.next_time }}</p>
    {% elif irr.mode == "sensor" %}
      <p style="margin: 4px 0;">ìˆ˜ë¶„ ì†Œëª¨ëŸ‰ : {{ irr.percent }}%</p>
    {% endif %}

    {% if irr.mode == "sensor" %}
    <div style="margin: 10px 0; display: flex; justify-content: center;">
      <canvas id="gauge{{ irr.channel }}" width="80" height="80"></canvas>
    </div>
    {% endif %}

    <div style="
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
    ">
      <button onclick="alert('ch{{ irr.channel }} ìˆ˜ë™ê´€ìˆ˜ ì‹œì‘'); sendManualToDjango('{{ irr.channel }}')"style="
        background-color: #eee;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
      ">ìˆ˜ë™ ê´€ìˆ˜</button>
    </div>
  </div>
  {% endfor %}
</div>

<h2 style="margin-top: 40px;">ğŸ’¡ LED í˜„í™©</h2>
<div style="display: flex; flex-wrap: wrap; gap: 20px;">
  {% for led in led_info %}
    <div style="
      background-color: #fff3e0;
      padding: 16px 20px;
      border-radius: 12px;
      width: 240px;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    ">
      <div id="led-lamp-{{ led.channel }}" style="
      position: absolute;
      top: 12px;
      right: 12px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #ccc;
      box-shadow: 0 0 4px #ccc;
    "></div>

      <h4 style="margin: 0 0 10px 0;">
        LED ch{{ led.channel }}
      </h4>
      <p style="margin: 2px 0;">LED ì‹œì‘ ì‹œê°„ : {{ led.on }}</p>
      <p style="margin: 2px 0;">LED ì¢…ë£Œ ì‹œê°„ : {{ led.off }}</p>
    </div>
  {% endfor %}
</div>

<script src="https://bernii.github.io/gauge.js/dist/gauge.min.js"></script>
<script>
window.addEventListener("DOMContentLoaded", () => {
  const clockEl = document.getElementById("desert-clock");
  const tempEl = document.getElementById("desert-temp");
  const humidityEl = document.getElementById("desert-humidity");

  if (clockEl) {
    let lastMinute = null;

    const updateEnvironmentReadings = () => {
      if (tempEl) {
        const temperature = (49.7 + Math.random() * 0.61).toFixed(1);
        tempEl.textContent = `${temperature}â„ƒ`;
      }
      if (humidityEl) {
        const humidity = (30 + Math.random() * 1.01).toFixed(1);
        humidityEl.textContent = `${humidity}%`;
      }
    };

    const updateClock = () => {
      const now = new Date();
      const hours = now.getHours().toString().padStart(2, "0");
      const minutes = now.getMinutes().toString().padStart(2, "0");
      clockEl.textContent = `${hours}:${minutes}`;

      if (lastMinute !== minutes) {
        lastMinute = minutes;
        updateEnvironmentReadings();
      }
    };

    updateClock();
    setInterval(updateClock, 15 * 1000);
  }

  // ğŸ”§ Gauge.js ì´ˆê¸°í™”
  {% for irr in irrigation_info %}
    {% if irr.mode == "sensor" %}
      const opts{{ irr.channel }} = {
        angle: 0.2,
        lineWidth: 0.35,
        radiusScale: 1,
        pointer: {
          length: 0.6,
          strokeWidth: 0.035,
          color: "#ff0000"
        },
        limitMax: false,
        limitMin: false,
        highDpiSupport: true
      };
      const target{{ irr.channel }} = document.getElementById("gauge{{ irr.channel }}");
      const gauge{{ irr.channel }} = new Gauge(target{{ irr.channel }}).setOptions(opts{{ irr.channel }});
      gauge{{ irr.channel }}.maxValue = 100;
      gauge{{ irr.channel }}.setMinValue(0);
      gauge{{ irr.channel }}.animationSpeed = 32;
      gauge{{ irr.channel }}.set({{ irr.percent|default:0 }});
    {% endif %}
  {% endfor %}

  // âœ… notify_socket_ready ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
  window.addEventListener("notify_socket_ready", () => {
    console.log("âœ… WebSocket ì¤€ë¹„ë¨ (dashboard)");

    // ğŸ”„ WebSocket ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì²˜ë¦¬
    window.addEventListener("message_from_socket", (event) => {
      const data = event.detail;
      console.log("ğŸ“¨ ìˆ˜ì‹  ë°ì´í„°:", data);

      if (data.cmd === "data") {
        const irrigation = data.data.irrigation || {};
        const led = data.data.led || {};

        for (const [key, val] of Object.entries(irrigation)) {
          const ch = key.replace("ch", "");
          const el = document.getElementById("irrigation-lamp-" + ch);
          if (el) {
            el.style.backgroundColor = val.state === 1 ? "limegreen" : "#ccc";
            el.style.boxShadow = `0 0 4px ${val.state === 1 ? "limegreen" : "#ccc"}`;
          }
        }

        for (const [key, val] of Object.entries(led)) {
          const ch = key.replace("ch", "");
          const el = document.getElementById("led-lamp-" + ch);
          if (el) {
            el.style.backgroundColor = val.state === 1 ? "limegreen" : "#ccc";
            el.style.boxShadow = `0 0 4px ${val.state === 1 ? "limegreen" : "#ccc"}`;
          }
        }
      }

      if (data.cmd === "logupdate") {
        console.log("ğŸ” ë¡œê·¸ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ ë¨ â†’ ìƒˆë¡œê³ ì¹¨");
        location.reload();
      }
    });
  });

  // âœ… ìˆ˜ë™ ê´€ìˆ˜ ëª…ë ¹ ì „ì†¡ í•¨ìˆ˜
  window.sendManualToDjango = function(ch) {
    if (!window.notifySocket || window.notifySocket.readyState !== WebSocket.OPEN) {
      alert("âŒ WebSocket ì—°ê²°ë˜ì§€ ì•ŠìŒ");
      return;
    }

    const message = { cmd: "manual", ch: ch };
    window.notifySocket.send(JSON.stringify(message));
    console.log("ğŸ“¤ ìˆ˜ë™ ê´€ìˆ˜ ëª…ë ¹ ì „ì†¡:", message);
  };

  // âœ… ë¹„ìƒ ì •ì§€ ëª…ë ¹ ì „ì†¡ í•¨ìˆ˜
  window.sendEmergency = function() {
    if (!window.notifySocket || window.notifySocket.readyState !== WebSocket.OPEN) {
      alert("âŒ WebSocket ì—°ê²°ë˜ì§€ ì•ŠìŒ");
      return;
    }

    const message = { cmd: "emergency" };
    window.notifySocket.send(JSON.stringify(message));
    console.log("ğŸ“¤ ë¹„ìƒ ì •ì§€ ëª…ë ¹ ì „ì†¡:", message);
  };
});
</script>




{% endblock %}
